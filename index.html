<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width">
<script type="module">
  import { style } from "https://js.sabae.cc/stdom.js";
  import L from "https://code4sabae.github.io/leaflet-mjs/leaflet.mjs";
  import { Geo3x3 } from "https://geo3x3.com/Geo3x3.js";
  import { CSV } from "https://js.sabae.cc/CSV.js";
  import { QRCode } from "https://code4fukui.github.io/qr-code/qr-code.js";
  import { fetchImage } from "https://js.sabae.cc/fetchImage.js";
  //import { InputCheckbox } from "https://code4fukui.github.io/input-checkbox/input-checkbox.js";
  import { create } from "https://js.sabae.cc/stdcomp.js";

  class CheckBox extends HTMLElement {
    constructor(s) {
      super();
      const label = create("label", this);
      this.inp = create("input", label);
      this.inp.type = "checkbox";
      create("span", label).textContent = s;
    }
    set checked(b) {
      this.inp.checked = b;
    }
    get checked() {
      return this.inp.checked;
    }
  }

  customElements.define("check-box", CheckBox);

  export { CheckBox };

  const getResized = (w, h, min) => {
    if (w > h) {
      return { width: min, height: (min * h) / w };
    } else {
      return { width: (min * w) / h, height: min };
    }
  };
  const makeTable = (d) => {
    const cr = (tag) => document.createElement(tag);
    const tbl = cr("table");
    for (const name in d) {
      const val = d[name];
      const tr = cr("tr");
      tbl.appendChild(tr);
      const th = cr("th");
      th.textContent = name;
      tr.appendChild(th);
      const td = cr("td");
      td.style.minWidth = "8em";
      td.style.wordBreak = "break-all";
      const n = val.match(/<a href=(.+)>(.+)<\/a>/);
      if (n) {
        const url = n[1];
        const cap = n[2];
        td.innerHTML = `<a href=${url}>${cap}</a>`;
      } else if (val.startsWith("https://")) {
        td.innerHTML = `<a href=${val}>詳細</a>`;
      } else {
        td.textContent = val;
      }
      tr.appendChild(td);
    }
    return tbl;
  };

  window.onload = async () => {
    const comp = document.body;

    const link = document.createElement("link");
    link.rel = "stylesheet";
    link.href =
      "https://code4sabae.github.io/leaflet-mjs/leaflet-grayscale.css";
    comp.appendChild(link);
    link.onload = () => init();
  };
  const init = async () => {
    const comp = document.body;

    document.body.style.margin = "0";
    document.body.style.textAlign = "center";
    comp.style.backgroundColor = "#D74938";
    comp.style.color = "white";
    
    document.title = "越前市岡本地区マップ「キッズセーフ岡本」";

    const header = document.createElement("header");
    header.style.height = "56px";
    header.style.margin = "0";
    header.style.display = "grid";
    header.style.gridTemplate =`
      "left-button subtitle right-button" 16px
      "left-button title rigth-button" 24px
      / 56px 1fr 56px
    `;
    header.style.gap = "8px";
    header.style.placeContent = "center";
    comp.appendChild(header);

    const menuButton = document.createElement("div");
    menuButton.style.gridArea = "left-button";
    menuButton.style.display = "grid";
    menuButton.style.placeContent = "center";
    menuButton.style.cursor = "pointer";
    menuButton.onclick = () => {
      drawer.style.display = "block";
    };
    header.appendChild(menuButton);

    const menuIconImage = document.createElement("img");
    menuIconImage.setAttribute("src", "./images/icon_menu.svg");
    menuIconImage.style.height = "40px";
    menuIconImage.style.width = "40px";
    menuButton.appendChild(menuIconImage);

    const subtitle = document.createElement("span");
    subtitle.textContent = "越前市岡本地区マップ";
    subtitle.style.fontSize = "16px";
    subtitle.style.lineHeight = "1";
    subtitle.style.gridArea = "subtitle";
    header.appendChild(subtitle);
    
    const title = document.createElement("span");
    title.textContent = "キッズセーフ岡本";
    title.style.fontSize = "24px";
    title.style.lineHeight = "1";
    title.style.fontWeight = "bold";
    title.style.gridArea = "title";
    header.appendChild(title);

    const div = document.createElement("div");
    comp.appendChild(div);
    div.className = "divmap";
    style({
      ".divmap": {
        width: "100%",
        height: "calc(100vh - 56px)",
      },
      "@media print": {
        // 印刷用CSS
        ".divmap": {
          width: "100%",
          height: "calc(100vh - 2em - 300px)",
          "background-color": "red",
        },
      },
    });

    const drawer = document.createElement("div");
    drawer.style.display = "none"; // 最初は非表示にする/表示するときはblock
    drawer.style.height = "100%";
    drawer.style.width = "300px";
    drawer.style.position = "absolute";
    drawer.style.top = "0";
    drawer.style.left = "0";
    drawer.style.zIndex = "1000"; // leafletの上に表示できる最小のz-indexがこれ
    drawer.style.backgroundColor = "white";
    drawer.style.color = "black";
    drawer.style.overflow = "hidden";
    comp.appendChild(drawer);

    const closeMenuButton = document.createElement("div");
    closeMenuButton.style.height = "56px";
    closeMenuButton.style.width = "56px";
    closeMenuButton.style.padding = "8px";
    closeMenuButton.style.display = "grid";
    closeMenuButton.style.placeContent = "center";
    closeMenuButton.onclick = () => {
      drawer.style.display = "none";
    };
    drawer.appendChild(closeMenuButton)

    const closeMenuIconImage = document.createElement("img");
    closeMenuIconImage.setAttribute("src", "./images/icon_close.svg");
    closeMenuIconImage.style.height = "40px";
    closeMenuIconImage.style.width = "40px";
    closeMenuButton.appendChild(closeMenuIconImage);

    const drawerItems = document.createElement("div");
    drawerItems.style.height = "calc(100% - 56px)";
    drawerItems.style.width = "100%";
    drawerItems.style.padding = "0 8px 16px";
    drawerItems.style.overflowY = "scroll";
    drawerItems.style.display = "flex";
    drawerItems.style.flexDirection = "column";
    drawerItems.style.gap = "8px";
    drawerItems.style.alignItems = "flex-start";
    drawer.appendChild(drawerItems);

    //
    const map = L.map(div);
    // set 国土地理院地図 https://maps.gsi.go.jp/development/ichiran.html
    L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png", {
      attribution:
        '<a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>"',
      maxZoom: 18,
    }).addTo(map);

    const getPos = (d) => {
      const pos = Geo3x3.decode(d.Geo3x3 || d.geo3x3);
      if (pos) {
        return [pos.lat, pos.lng];
      }
      return [d.lat || d.緯度, d.lng || d.経度];
    };

    const lls = [];
    const showIcons = async (list, icon) => {
      //const icon = "./icon/" + icon0;
      const iconlayer = L.layerGroup();
      iconlayer.addTo(map);
      const opt = {};
      try {
        const img = await fetchImage(icon);
        const size = getResized(img.width, img.height, 50);
        const iconw = size.width;
        const iconh = size.height;
        opt.icon = L.icon({
          iconUrl: icon,
          iconRetilaUrl: icon,
          iconSize: [iconw, iconh],
          iconAnchor: [iconw / 2, iconh / 2],
          popupAnchor: [0, -iconh / 2],
        });
      } catch (e) {
        console.log("can't load: " + icon);
      }
      for (const d of list) {
        const ll = getPos(d);
        const marker = L.marker(ll, opt);
        const tbl = makeTable(d);
        tbl.className = "mapinfo";
        marker.bindPopup(tbl.outerHTML); // `<img width="300px" src=${path}>`);
        iconlayer.addLayer(marker);
        lls.push(ll);
      }
      return iconlayer;
    };
    const showPoints = async (list, color) => {
      const iconlayer = L.layerGroup();
      iconlayer.addTo(map);
      for (const d of list) {
        const ll = getPos(d);
        //const ll = [d.lat, d.lng];
        const marker = L.circle(ll, {
          radius: 2,
          color,
          fillColor: color,
          fillOpacity: 1,
        });
        const tbl = makeTable(d);
        tbl.className = "mapinfo";
        marker.bindPopup(tbl.outerHTML); // `<img width="300px" src=${path}>`);
        iconlayer.addLayer(marker);
        lls.push(ll);
      }
      return iconlayer;
    };
    style({
      ".mapinfo": {
        color: "black",
      },
      ".mapinfo td": {
        "text-align": "left",
        "white-space": "pre-wrap",
      },
    });

    //
    const layers = [];

    { // 地域情報
      const list = CSV.toJSON(await CSV.fetchUtf8("./point.csv"));
      //layers.push(["地域情報", await showPoints(list, "#f00")]);
      layers.push(["地域情報", await showIcons(list)]);
    }

    if (lls.length) {
      map.fitBounds(lls);
    }

    { // 世界記録チャレンジ
      const list = CSV.toJSON(await CSV.fetchUtf8("https://code4fukui.github.io/worldsrecords-challenge/data.csv"));
      layers.push(["世界記録チャレンジ", await showIcons(list, "https://code4fukui.github.io/worldsrecords-challenge/image/icon.png")]);
    }
    { // デザインマンホール
      const list = CSV.toJSON(await CSV.fetchUtf8("https://code4fukui.github.io/design-manhole-map/data.csv"));
      layers.push(["デザインマンホール", await showIcons(list, "https://code4fukui.github.io/worldsrecords-challenge/image/icon.png")]);
    }

    // レイヤー選択
    {
      for (const layer of layers) {
        const chk = new CheckBox(layer[0]);
        drawerItems.appendChild(chk);
        chk.checked = true;
        chk.onchange = () => {
          if (chk.checked) {
            map.addLayer(layer[1]);
          } else {
            map.removeLayer(layer[1]);
          }
        };
      }
    }

    // 現在地を取得してピンを打つ
    const currentPositionMarker = L.marker([36, 140], {title: "現在地"}).addTo(map).bindPopup("現在地");
    navigator.geolocation.getCurrentPosition((position) => {
      const currentLoc = [position.coords.latitude, position.coords.longitude];
      currentPositionMarker.setLatLng(currentLoc);
    })

    // 現在地を監視してピン/マップを動かす
    const watchGPS = new CheckBox("現在地追従モード")
    let watchPosition;
    watchGPS.checked = false
    watchGPS.onchange = () => {
      if (watchGPS.checked) {
        watchPosition = navigator.geolocation.watchPosition((position) => {
          const currentLoc = [position.coords.latitude, position.coords.longitude];
          currentPositionMarker.setLatLng(currentLoc);
          map.setView(currentLoc, 16);
        });
      } else {
        navigator.geolocation.clearWatch(watchPosition);
      }
    };
    drawerItems.appendChild(watchGPS);

    // footer
    const links = [
      { text: "データ編集や閲覧はGitHubで", url: "https://github.com/code4fukui/okamoto/" },
      { text: "下記データは、オープンデータライセンスでご利用いただけます", url: "https://github.com/code4fukui/opendata-license/" },
    ];
    for (const link of links) {
      const a = document.createElement("a");
      a.style.display = "block";
      a.style.textAlign = "left";
      a.textContent = link.text;
      a.href = link.url;
      drawerItems.appendChild(a);
    }

    const qr = new QRCode();
    qr.style.width = "100%";
    qr.style.display = "grid";
    qr.style.placeContent = "center";
    drawerItems.appendChild(qr);
  };
</script>

<style>
  * {
    box-sizing: border-box;
  }

  .selectlayers {
    margin: 1em;
  }
</style>